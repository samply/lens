<script lang="ts">
    import {
        setCatalogue,
        setOptions,
        showErrorToast,
        translate,
    } from "./src/index";
    import type { QueryEvent, Site } from "./src/index";

    setOptions({
        language: localStorage.getItem("language") || "en",
        texts: {
            "lens-dev-test-error": {
                en: "Task failed successfully.",
                de: "Aufgabe erfolgreich fehlgeschlagen.",
            },
        },
        siteMappings: {
            riverside: "Riverside",
            summit: "Summit",
        },
        catalogueKeyToResponseKeyMap: [
            ["gender", "Gender"],
            ["diagnosis", "diagnosis-icd10"],
        ],
        chartOptions: {
            gender: {
                hintText: [
                    "This pie chart shows the proportion of males to females in our [population/data set]. The size of each section represents the percentage of individuals who identify as male or female.",
                ],
                legendMapping: {
                    male: "Männlich",
                    female: "Weiblich",
                    other: "Divers",
                },
            },
        },
        tableOptions: {
            headerData: [
                {
                    title: "Standorte",
                    dataKey: "site",
                },
                {
                    title: "Patienten",
                    dataKey: "patients",
                },
            ],
        },
        resultSummaryOptions: {
            title: "Ergebnisse",
            infoButtonText: "This is a tooltip",
            dataTypes: [
                {
                    title: "Standorte",
                    dataKey: "collections",
                },
                {
                    title: "Patienten",
                    dataKey: "patients",
                },
            ],
        },
    });

    setCatalogue([
        {
            fieldType: "autocomplete",
            key: "diagnosis",
            name: "Diagnosis",
            type: "EQUALS",
            system: "http://fhir.de/CodeSystem/dimdi/icd-10-gm",
            infoButtonText: ["Diagnosis"],
            criteria: [
                {
                    key: "C31",
                    name: "C31",
                    description: "Malignant neoplasm of accessory sinuses",
                },
                {
                    key: "C31.0",
                    name: "C31.0",
                    description: "Malignant neoplasm: Maxillary sinus",
                },
                {
                    key: "C41",
                    name: "C41",
                    description:
                        "Malignant neoplasm of bone and articular cartilage of other and unspecified sites",
                },
                {
                    key: "C41.0",
                    name: "C41.0",
                    description: "Malignant neoplasm: Bones of skull and face",
                },
                {
                    key: "C41.1",
                    name: "C41.1",
                    description: "Malignant neoplasm: Bones of vertebrae",
                },
                {
                    key: "C41.2",
                    name: "C41.2",
                    description: "Malignant neoplasm: Bones of pelvis",
                },
            ],
        },
        {
            fieldType: "single-select",
            key: "blood-group",
            name: "Blood group",
            type: "EQUALS",
            system: "",
            criteria: [
                {
                    key: "A+",
                    name: "A+",
                    description: "",
                },
                {
                    key: "A-",
                    name: "A-",
                    description: "",
                },
                {
                    key: "B+",
                    name: "B+",
                    description: "",
                },
                {
                    key: "B-",
                    name: "B-",
                    description: "",
                },
            ],
        },
        {
            fieldType: "number",
            key: "body_weight",
            name: "Body weight",
            type: "BETWEEN",
            system: "",
            min: 0,
            unitText: "kg",
        },
        {
            fieldType: "date",
            key: "date-of-birth",
            name: "Date of birth",
            type: "BETWEEN",
            system: "",
            max: "2025-09-04",
        },
        {
            fieldType: "string",
            key: "first-name",
            name: "First name",
            type: "EQUALS",
            system: "",
        },
        {
            fieldType: "group",
            key: "donor",
            name: "Donor/Clinical Information",
            childCategories: [
                {
                    key: "gender",
                    name: "Gender",
                    fieldType: "single-select",
                    type: "EQUALS",
                    system: "",
                    criteria: [
                        {
                            key: "male",
                            name: "male",
                            description: "",
                        },
                        {
                            key: "female",
                            name: "female",
                            description: "",
                        },
                        {
                            key: "other",
                            name: "other",
                            description: "",
                        },
                        {
                            key: "sex_uncharted",
                            name: "sex uncharted",
                            description: "",
                        },
                    ],
                },
                {
                    key: "diagnosis",
                    name: "Diagnosis ICD-10",
                    fieldType: "autocomplete",
                    type: "EQUALS",
                    system: "http://fhir.de/CodeSystem/dimdi/icd-10-gm",
                    criteria: [
                        {
                            key: "C31",
                            name: "C31",
                            description:
                                "Malignant neoplasm of accessory sinuses",
                        },
                        {
                            key: "C31.0",
                            name: "C31.0",
                            description: "Malignant neoplasm: Maxillary sinus",
                        },
                        {
                            key: "C41",
                            name: "C41",
                            description:
                                "Malignant neoplasm of bone and articular cartilage of other and unspecified sites",
                        },
                        {
                            key: "C41.0",
                            name: "C41.0",
                            description:
                                "Malignant neoplasm: Bones of skull and face",
                        },
                    ],
                },
                {
                    key: "age_at_diagnosis",
                    name: "Diagnosis age",
                    fieldType: "number",
                    type: "BETWEEN",
                    system: "",
                },
            ],
        },
        {
            fieldType: "group",
            key: "tumor_entity",
            name: "Tumorentität",
            childCategories: [
                {
                    fieldType: "group",
                    key: "urn:dktk:code:2:2",
                    name: "Neuroonkologie",
                    childCategories: [
                        {
                            key: "gliom_all_groups",
                            name: "Gliome, alle Gruppen",
                            fieldType: "single-select",
                            type: "EQUALS",
                            system: "",
                            criteria: [
                                {
                                    key: "urn:dktk:code:3:2",
                                    name: "Gliom - Grad I",
                                    description: "",
                                    aggregatedValue: [
                                        [
                                            {
                                                value: "diagnosis",
                                                name: "D43.%",
                                            },
                                        ],
                                        [
                                            {
                                                value: "59847-4",
                                                name: "9383/1",
                                            },
                                            {
                                                value: "59847-4",
                                                name: "9384/1",
                                            },
                                            {
                                                value: "59847-4",
                                                name: "9394/1",
                                            },
                                            {
                                                value: "59847-4",
                                                name: "9421/1",
                                            },
                                        ],
                                    ],
                                },
                            ],
                        },
                    ],
                },
            ],
        },
        {
            fieldType: "string",
            key: "sample-id",
            name: "Sample ID",
            infoButtonText: ["Sample ID"],
            type: "EQUALS",
            system: "",
        },
    ]);

    function sleep(ms: number): Promise<void> {
        return new Promise((resolve) => {
            setTimeout(resolve, ms);
        });
    }

    window.addEventListener("emit-lens-query", (event) => {
        const detail = (event as QueryEvent).detail;
        console.log("AST:", JSON.stringify(detail.ast));
        sleep(3000).then(() => {
            detail.updateResponse(new Map([["riverside", makeSite(5, 4, 0)]]));
            detail.updateResponse(new Map([["summit", makeSite(12, 18, 3)]]));
        });
    });

    function setLangAndReload(lang: string) {
        localStorage.setItem("language", lang);
        window.location.reload();
    }

    /**
     * Create a mock {@link Site} response
     */
    function makeSite(male: number, female: number, other: number): Site {
        return {
            status: "succeeded",
            data: {
                date: "2025-03-13T09:39:22.238610329Z",
                extension: [
                    {
                        url: "https://samply.github.io/blaze/fhir/StructureDefinition/eval-duration",
                        valueQuantity: {
                            code: "s",
                            system: "http://unitsofmeasure.org",
                            unit: "s",
                            value: 7.755854268,
                        },
                        valueRatio: null,
                    },
                    {
                        url: "https://samply.github.io/blaze/fhir/StructureDefinition/bloom-filter-ratio",
                        valueQuantity: null,
                        valueRatio: {
                            denominator: {
                                value: 0,
                            },
                            numerator: {
                                value: 0,
                            },
                        },
                    },
                ],
                group: [
                    {
                        code: {
                            text: "patients",
                        },
                        population: [
                            {
                                code: {
                                    coding: [
                                        {
                                            code: "initial-population",
                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                        },
                                    ],
                                },
                                count: male + female + other,
                            },
                        ],
                        stratifier: [
                            {
                                code: [
                                    {
                                        text: "Gender",
                                    },
                                ],
                                stratum: [
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: male,
                                            },
                                        ],
                                        value: {
                                            text: "male",
                                        },
                                    },
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: female,
                                            },
                                        ],
                                        value: {
                                            text: "female",
                                        },
                                    },
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: other,
                                            },
                                        ],
                                        value: {
                                            text: "other",
                                        },
                                    },
                                ],
                            },
                        ],
                    },
                    {
                        code: {
                            text: "diagnosis-icd10",
                        },
                        population: [
                            {
                                code: {
                                    coding: [
                                        {
                                            code: "initial-population",
                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                        },
                                    ],
                                },
                                count: 100,
                            },
                        ],
                        stratifier: [
                            {
                                code: [
                                    {
                                        text: "diagnosis-icd10",
                                    },
                                ],
                                stratum: [
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: 40,
                                            },
                                        ],
                                        value: {
                                            text: "C31",
                                        },
                                    },
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: 20,
                                            },
                                        ],
                                        value: {
                                            text: "C31.0",
                                        },
                                    },
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: 30,
                                            },
                                        ],
                                        value: {
                                            text: "C41",
                                        },
                                    },
                                    {
                                        population: [
                                            {
                                                code: {
                                                    coding: [
                                                        {
                                                            code: "initial-population",
                                                            system: "http://terminology.hl7.org/CodeSystem/measure-population",
                                                        },
                                                    ],
                                                },
                                                count: 10,
                                            },
                                        ],
                                        value: {
                                            text: "41.0",
                                        },
                                    },
                                ],
                            },
                        ],
                    },
                ],
                measure: "urn:uuid:19a1b508-eaa1-483a-b9a2-26f505509e6a",
                period: {
                    end: "2030",
                    start: "2000",
                },
                resourceType: "MeasureReport",
                status: "complete",
                type: "summary",
            },
        };
    }
</script>

<header style="padding: 10px;">
    <h2 style="margin: 0;">Lens Dev</h2>
</header>

<div style="display: flex; padding: 10px; gap: 10px;">
    <div style="flex: 1">
        <lens-search-bar-multiple></lens-search-bar-multiple>
    </div>
    <lens-info-button noQueryMessage="Empty Query" showQuery={true}
    ></lens-info-button>
    <lens-search-button></lens-search-button>
    <lens-query-spinner></lens-query-spinner>
</div>

<div style="display: flex; padding: 10px; gap: 10px;">
    <div style="flex: 1">
        <lens-catalogue toggle={{ open: true }}></lens-catalogue>
    </div>
    <div style="flex: 1">
        <lens-result-summary></lens-result-summary>
        <lens-negotiate-button title="Request Data"></lens-negotiate-button>
        <lens-search-modified-display></lens-search-modified-display>
        <lens-result-table></lens-result-table>
        <lens-chart
            title="Geschlecht"
            catalogueGroupCode="gender"
            chartType="pie"
            displayLegends="true"
        ></lens-chart>
        <lens-chart
            title="diagnosis"
            catalogueGroupCode="diagnosis"
            chartType="bar"
            xAxisTitle="ICD-10-Codes"
            yAxisTitle="Anzahl der Diagnosen"
        ></lens-chart>
        <lens-chart
            title="diagnosis"
            catalogueGroupCode="diagnosis"
            indexAxis="y"
            scaleType="logarithmic"
            chartType="bar"
            xAxisTitle="Anzahl der Diagnosen"
            yAxisTitle="ICD-10-Codes"
        ></lens-chart>
    </div>
</div>

<footer style="display: flex; padding: 10px; gap: 10px;">
    <button
        id="error-toast-test-button"
        onclick={() => showErrorToast(translate("lens-dev-test-error"))}
        >Error toast test</button
    >
    <button
        id="switch-language-to-german-button"
        onclick={() => setLangAndReload("de")}>🇩🇪</button
    ><button
        id="switch-language-to-english-button"
        onclick={() => setLangAndReload("en")}>🇬🇧</button
    >
    <span
        >Made with ♥ and <a href="https://github.com/samply/lens"
            >samply/lens</a
        >.</span
    >
</footer>

<error-toasts></error-toasts>
